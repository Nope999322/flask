{% extends 'base.html' %}
{% block title %}{{ district.name }}{% endblock %}

{% block content %}
<h1 class="mb-3">{{ district.name }}</h1>

{# ===== Галерея миниатюр ===== #}
{% if district.images %}
  <div class="row mb-4">
    {% for img in district.images %}
      <div class="col-6 col-md-4 col-lg-3 mb-3">
        <img src="{{ url_for('static', filename='districts/' ~ img.filename) }}"
             class="img-fluid rounded shadow-sm gallery-thumb"
             alt="{{ district.name }}"
             data-index="{{ loop.index0 }}">
      </div>
    {% endfor %}
  </div>
{% endif %}

{# ===== Описание ===== #}
{% if district.description %}
  <p class="lead mb-4">{{ district.description }}</p>
{% else %}
  <p class="text-muted mb-4">Описание района не задано.</p>
{% endif %}

<hr>

<h3>Оставить отзыв</h3>
{% if current_user.is_authenticated %}
  <form method="post">
    <div class="mb-2">
      <label class="form-label">Оценка (1–5)</label>
      <input type="number" name="rating" min="1" max="5" class="form-control" required>
    </div>
    <div class="mb-2">
      <label class="form-label">Комментарий</label>
      <textarea name="comment" class="form-control" rows="3"></textarea>
    </div>
    <button class="btn btn-success" type="submit">Отправить</button>
  </form>
{% else %}
  <div class="alert alert-warning">
    Чтобы оставить отзыв, <a href="{{ url_for('login', next=request.path) }}">войдите на сайт</a>.
  </div>
{% endif %}

<hr>

<h3>Отзывы</h3>
{% if reviews %}
  {% for r in reviews %}
    <div class="mb-3 border rounded p-2">
      <div class="d-flex justify-content-between">
        <div>
          <strong>{{ r.author.username }}</strong>
          <span class="text-warning ms-2">Оценка: {{ r.rating }}/5</span><br>
          <small class="text-muted">{{ r.created_at }}</small>
        </div>

        {% if current_user.is_authenticated and current_user.is_admin %}
          <form method="post"
                action="{{ url_for('admin_delete_review', review_id=r.id) }}"
                onsubmit="return confirm('Удалить этот отзыв?');"
                style="display:inline;">
            <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
          </form>
        {% endif %}
      </div>
      <p class="mb-0 mt-2">{{ r.comment }}</p>
    </div>
  {% endfor %}
{% else %}
  <p>Отзывов пока нет.</p>
{% endif %}

{# ===== Модальное окно для просмотра изображений ===== #}
<div class="modal fade" id="galleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ district.name }} — фотография</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="galleryModalImage" src="" class="img-fluid rounded" alt="{{ district.name }}">
      </div>
      <div class="modal-footer justify-content-between">
        <div>
          <button type="button" class="btn btn-outline-secondary" id="prevImage">‹ Назад</button>
          <button type="button" class="btn btn-outline-secondary" id="nextImage">Вперёд ›</button>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

{# ===== JS для листания изображений ===== #}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const thumbs = Array.from(document.querySelectorAll('.gallery-thumb'));
    if (!thumbs.length) return;

    // массив ссылок на изображения
    const images = thumbs.map(img => img.getAttribute('src'));
    let currentIndex = 0;

    const modalEl = document.getElementById('galleryModal');
    const modalImg = document.getElementById('galleryModalImage');
    const bsModal = new bootstrap.Modal(modalEl);

    function showImage(index) {
      if (index < 0) index = images.length - 1;
      if (index >= images.length) index = 0;
      currentIndex = index;
      modalImg.src = images[currentIndex];
    }

    thumbs.forEach((thumb, idx) => {
      thumb.addEventListener('click', () => {
        showImage(idx);
        bsModal.show();
      });
    });

    document.getElementById('prevImage').addEventListener('click', function () {
      showImage(currentIndex - 1);
    });

    document.getElementById('nextImage').addEventListener('click', function () {
      showImage(currentIndex + 1);
    });
  });
</script>
{% endblock %}
